name: Deploy Lambda agreements feedback handler

on:
  push:
    branches: [ "main" ]
    paths:
      - "lambda_agreements_feedback_handler/**"
      - ".github/workflows/deploy-lambda-agreements-feedback-handler.yml"
    workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-lambda-agreements-feedback-handler
  cancel-in-progress: true


jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ZIP_NAME: lambda_agreements_feedback_handler.zip
      LAMBDA_FUNCTION_NAME: agreements_feedback_handler
      BUILD_IMAGE: lambda-zip-builder:py314
      CONTAINER_NAME: lambda_zip_build_tmp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_PROD }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build docker image (linux/amd64)
        working-directory: lambda_agreements_feedback_handler
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -f Dockerfile.lambda-build \
            -t "${BUILD_IMAGE}" \
            --load \
            .

      - name: Create container and extract /asset
        working-directory: lambda_agreements_feedback_handler
        run: |
          docker rm -f "${CONTAINER_NAME}" >/dev/null 2>&1 || true
          docker create --name "${CONTAINER_NAME}" "${BUILD_IMAGE}" >/dev/null

          rm -rf build_asset
          mkdir -p build_asset

          docker cp "${CONTAINER_NAME}:/asset/." build_asset/
          docker rm -f "${CONTAINER_NAME}" >/dev/null

      - name: Zip build_asset
        working-directory: lambda_agreements_feedback_handler
        run: |
          rm -f "${ZIP_NAME}"
          ( cd build_asset && zip -q -r9 "../${ZIP_NAME}" . )
          ls -lh "${ZIP_NAME}"

      - name: Update Lambda function code
        run: |
          aws lambda update-function-code \
            --function-name "${LAMBDA_FUNCTION_NAME}" \
            --zip-file "fileb:${ZIP_NAME}" \
            --publish \
            --output json
